---
jupyter:
  jupytext:
    formats: ipynb,md
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.2'
      jupytext_version: 1.5.1
  kernelspec:
    display_name: collatz
    language: python
    name: collatz
---

<!-- #region pycharm={"name": "#%% md\n"} -->
# Binary learner

This notebook trains machine learning models that predict features of Collatz
sequences based on their binary representation
<!-- #endregion -->

## Meta data

```python pycharm={"name": "#%%\n"}
"""
This notebook trains machine learning models that predict features of Collatz
sequences based on their binary representation. It builds on a sample of sequences,
stored in the csv file: data/alpha_export.csv. The file can be generated by executing the script
run_alpha_export.py.
"""

# Imports
# Fix possible import problems
import sys
sys.path.append("../..")

from pathlib import Path
from math import log2
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np
from sklearn import linear_model, tree
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, f1_score
from sklearn.tree import export_graphviz
import pydotplus
from notebooks import nbsetup
from collatz import commons


# Helper methods
def _to_binary(int_value):
    """
    This method returns the binary representation of
    a specific int value as string.
    :param int_value: The int value, if a str is handed
    over it is converted to an int.
    :return: The binary representation as string.
    """
    if type(int_value) == str:
        int_value = int(int_value)
    return commons.to_binary(int_value)


# Configuration
DATA_PATH = Path.cwd().parent.parent.as_posix() + "/data/"
CSV_PATH = DATA_PATH + "alpha_export.csv"
LAMBDA_I_PATH = DATA_PATH + "lambda_i_tree.png"
OMEGA_PATH = DATA_PATH + "omega_tree.png"
ALPHA_G_PATH = DATA_PATH + "alpha_tree.png"
ALPHA_I_PATH = DATA_PATH + "alpha_i_tree.png"
SAVE_RESULTS = False

nbsetup.set_default_pd_options()

# Load data from csv
analysis_frame = pd.read_csv(
    CSV_PATH, dtype={
        "v_i": object, "kv_i+1": object, "v_i+" : object,
        "v_1_bin" : str, "v_i_bin" : str})

# Filter data set
K_FACTOR = 3
analysis_frame = analysis_frame[analysis_frame["k"] == K_FACTOR]

sequence_count = int(analysis_frame["sequence_id"].nunique())
print("K:", K_FACTOR)
print("Collatz sequences in sample:", sequence_count, "\n")

# Derive additional features
analysis_frame["b_i_log2"] = analysis_frame["b_i"].apply(log2)
analysis_frame["b_log2"] = analysis_frame["b"].apply(log2)
analysis_frame["v_1_log2"] = analysis_frame["v_1"].apply(log2)
analysis_frame["v_1_log_frac"] = analysis_frame["v_1_log2"] % 1
analysis_frame["v_1_mod4"] = analysis_frame["v_1"] % 4
analysis_frame["v_i_log_frac"] = analysis_frame["v_i_log2"] % 1
analysis_frame["o_i_pos"] = np.where(analysis_frame["o_i"] > 0, 1, 0)
analysis_frame["a_i_g"] = np.where(analysis_frame["a_i"] > 2, 1, 0)
analysis_frame["l_max_r"] = analysis_frame["l"] >= analysis_frame["l_max"]

# Binary features
max_bin_len = int(analysis_frame["bin_len"].max())
analysis_frame["bin_str"] = analysis_frame["v_i"].apply(_to_binary).str.zfill(max_bin_len)
bin_features = []

for i in range(0, max_bin_len):
    col_name = "b" + str(max_bin_len - i)
    bin_bool = analysis_frame["bin_str"].str[i] == "1"
    analysis_frame[col_name] = np.where(bin_bool == True, 1, 0)
    bin_features.append(col_name)

# Split Training and Test set
training_frame, test_frame = train_test_split(analysis_frame, test_size=0.3)

print("Size training set: ", len(training_frame))
print("Size test set: ", len(test_frame))

```

## Predict $\Lambda_i$

```python pycharm={"name": "#%%\n"}
# Features
lambda_i_target = "l_i"
lambda_i_features = ["v_i_log_frac", "terminal"]

# Create Training Set
lambda_i_training_target = training_frame[lambda_i_target]
lambda_i_training_features = training_frame[lambda_i_features]

# Create Test set
lambda_i_test_target = test_frame[lambda_i_target]
lambda_i_test_features = test_frame[lambda_i_features]

# Train Decision Tree
lambda_i_tree = tree.DecisionTreeClassifier()
lambda_i_tree.max_depth = 5
lambda_i_tree.fit(lambda_i_training_features, lambda_i_training_target)

# Plot Tree
plt.figure()
tree.plot_tree(
    lambda_i_tree, class_names=True, feature_names=lambda_i_features,
    impurity=False, rounded=False, filled=True)
plt.show()

# Test Model
lambda_i_predicted = lambda_i_tree.predict(lambda_i_test_features)
lambda_i_accuracy = accuracy_score(lambda_i_test_target, lambda_i_predicted)
lambda_i_f1 = f1_score(lambda_i_test_target, lambda_i_predicted)

print("Decision Tree")
print("Features:", lambda_i_features)
print("Accuracy:", lambda_i_accuracy)
print("F1:", lambda_i_f1)

# Export Tree
if SAVE_RESULTS:
    lambda_i_graph_data = export_graphviz(lambda_i_tree, out_file=None,
                feature_names = lambda_i_features,
                class_names = True, rounded = True, proportion = False,
                precision = 3, filled = True)

    lambda_i_graph = pydotplus.graph_from_dot_data(lambda_i_graph_data)
    lambda_i_graph.write_png(LAMBDA_I_PATH)
    print("Tree exported to:", Path(LAMBDA_I_PATH).name)
```

## Predict $\Lambda$

```python pycharm={"name": "#%%\n"}
# Features
lambda_target = "l"
lambda_features = ["n", "v_i_log_frac"]

# Create Training Set
lambda_training_target = training_frame[lambda_target]
lambda_training_features = training_frame[lambda_features]

# Create Test set
lambda_test_target = test_frame[lambda_target]
lambda_test_features = test_frame[lambda_features]

# Train Linear Model
lambda_regression = linear_model.LinearRegression()
lambda_regression.fit_intercept = False
lambda_regression.fit(lambda_training_features, lambda_training_target)

# Test Model
lambda_predicted = lambda_regression.predict(lambda_test_features)

plt.figure()
plt.title("Lambda vs. Lambda predicted")
plt.plot(lambda_predicted, lambda_test_target,  "o")
plt.show()

print("Linear Model")
print("Intercept:", lambda_regression.intercept_)
print("Features:", lambda_features)
print("Coeff:", lambda_regression.coef_)
print("R^2:", lambda_regression.score(
    lambda_training_features, lambda_training_target))
```

## Predict $\Omega_i$ > 0

```python pycharm={"name": "#%%\n"}
# Features
omega_target = "o_i_pos"
omega_features = ["v_i_mod4", "v_i_log_frac"]

# Create Training Set
omega_training_target = training_frame[omega_target]
omega_training_features = training_frame[omega_features]

# Create Test set
omega_test_target = test_frame[omega_target]
omega_test_features = test_frame[omega_features]

# Train Decision Tree
omega_tree = tree.DecisionTreeClassifier()
omega_tree.max_depth = 5
omega_tree.fit(omega_training_features, omega_training_target)

# Plot Tree
plt.figure()
tree.plot_tree(
    omega_tree, class_names=True, feature_names=omega_features,
    impurity=False, rounded=False, filled=True)
plt.show()

# Test Model
omega_predicted = omega_tree.predict(omega_test_features)
omega_accuracy = accuracy_score(omega_test_target, omega_predicted)
omega_f1 = f1_score(omega_test_target, omega_predicted)

print("Decision Tree")
print("Features:", omega_features)
print("Accuracy:", omega_accuracy)
print("F1:", omega_f1)

# Export Tree
if SAVE_RESULTS:
    omega_graph_data = export_graphviz(omega_tree, out_file=None,
                feature_names = omega_features,
                class_names = True, rounded = True, proportion = False,
                precision = 3, filled = True)

    omega_graph = pydotplus.graph_from_dot_data(omega_graph_data)
    omega_graph.write_png(OMEGA_PATH)
    print("Tree exported to:", Path(OMEGA_PATH).name)

```

## Predict $\alpha_i > 2$

```python pycharm={"name": "#%%\n"}
# Features
alpha_g_target = "a_i_g"
tz = max_bin_len

alpha_g_features = bin_features

# Create Training Set
alpha_g_training_target = training_frame[alpha_g_target]
alpha_g_training_features = training_frame[alpha_g_features]

# Create Test set
alpha_g_test_target = test_frame[alpha_g_target]
alpha_g_test_features = test_frame[alpha_g_features]

# Train Decision Tree
alpha_g_tree = tree.DecisionTreeClassifier()
alpha_g_tree.fit(alpha_g_training_features, alpha_g_training_target)

# Plot Tree
plt.figure()
tree.plot_tree(
    alpha_g_tree, class_names=True, feature_names=alpha_g_features,
    impurity=False, rounded=False, filled=True)
plt.show()

# Test Model
alpha_g_predicted = alpha_g_tree.predict(alpha_g_test_features)
alpha_g_accuracy = accuracy_score(alpha_g_test_target, alpha_g_predicted)
alpha_g_f1 = f1_score(alpha_g_test_target, alpha_g_predicted)

print("Decision Tree")
print("Accuracy:", alpha_g_accuracy)
print("F1:", alpha_g_f1)

# Export Tree
if SAVE_RESULTS:
    alpha_g_graph_data = export_graphviz(alpha_g_tree, out_file=None,
                feature_names = alpha_g_features,
                class_names = True, rounded = True, proportion = False,
                precision = 3, filled = True)

    alpha_g_graph = pydotplus.graph_from_dot_data(alpha_g_graph_data)
    alpha_g_graph.write_png(ALPHA_G_PATH)
    print("Tree exported to:", Path(ALPHA_G_PATH).name)

```

## Predict $\alpha_i$

```python pycharm={"name": "#%%\n"}
# Features
alpha_i_target = "a_i"
alpha_i_features = bin_features

# Create Training Set
alpha_i_training_target = training_frame[alpha_i_target]
alpha_i_training_features = training_frame[alpha_i_features]

# Create Test set
alpha_i_test_target = test_frame[alpha_i_target]
alpha_i_test_features = test_frame[alpha_i_features]

# Train Decision Tree
alpha_i_tree = tree.DecisionTreeRegressor()
alpha_i_tree.fit(alpha_i_training_features, alpha_i_training_target)

# Plot Tree
plt.figure()
tree.plot_tree(
    alpha_i_tree, class_names=True, feature_names=alpha_i_features,
    impurity=False, rounded=False, filled=True)
plt.show()

# Test Model
alpha_i_predicted = alpha_i_tree.predict(alpha_i_test_features)

plt.figure()
plt.title("Alpha vs. Alpha predicted")
plt.plot(alpha_i_predicted, alpha_i_test_target,  "o")
plt.show()

print("Decision Tree")
print("R^2:", alpha_i_tree.score(
    alpha_i_training_features, alpha_i_training_target))

# Export Tree
if SAVE_RESULTS:
    alpha_i_graph_data = export_graphviz(alpha_i_tree, out_file=None,
                feature_names = alpha_i_features,
                class_names = True, rounded = True, proportion = False,
                precision = 3, filled = True)

    alpha_i_graph = pydotplus.graph_from_dot_data(alpha_i_graph_data)
    alpha_i_graph.write_png(ALPHA_I_PATH)
    print("Tree exported to:", Path(ALPHA_I_PATH).name)
```
